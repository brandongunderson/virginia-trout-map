"use strict";(()=>{var e={};e.id=308,e.ids=[308],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},629:e=>{e.exports=require("fs/promises")},5315:e=>{e.exports=require("path")},4082:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>j,patchFetch:()=>k,requestAsyncStorage:()=>$,routeModule:()=>S,serverHooks:()=>x,staticGenerationAsyncStorage:()=>E});var a={};r.r(a),r.d(a,{GET:()=>w,POST:()=>y});var s=r(6618),o=r(830),n=r(4316),c=r(8370);let l="https://services.dwr.virginia.gov/arcgis/rest/services/Projects/TroutApp/MapServer",i={"stocked-streams":`${l}/0/query`,"stocked-lakes":`${l}/1/query`,"wild-streams":`${l}/2/query`};async function u(e){let t=i[e],r=new URLSearchParams({where:"1=1",outFields:"*",f:"geojson",returnGeometry:"true"});try{let e=await fetch(`${t}?${r.toString()}`,{headers:{Accept:"application/json"}});if(!e.ok)throw Error(`HTTP error! status: ${e.status}`);let a=await e.json();return a.features&&Array.isArray(a.features)&&(a.features=a.features.map(e=>({...e,properties:function(e){let t={};return[{target:"name",sources:["Name","NAME","name","WATER_NAME","WaterName"]},{target:"county",sources:["County","COUNTY","county","COUNTY_NAME"]},{target:"type",sources:["Type","TYPE","type","WATER_TYPE","WaterType"]},{target:"species",sources:["Species","SPECIES","species","TROUT_SPECIES"]},{target:"description",sources:["Description","DESCRIPTION","description","DESC"]}].forEach(({target:r,sources:a})=>{for(let s of a)if(void 0!==e[s]&&null!==e[s]){t[r]=e[s];break}}),Object.assign(t,e),t}(e.properties)}))),a}catch(t){throw console.error(`Error fetching ${e} data:`,t),Error(`Failed to fetch ${e} data: ${t instanceof Error?t.message:"Unknown error"}`)}}async function d(){return await Promise.all(["stocked-streams","stocked-lakes","wild-streams"].map(async e=>{try{let t=await u(e);return console.log(`✓ Successfully fetched ${e} from external API`),{type:e,data:t,lastUpdated:new Date().toISOString()}}catch{console.log(`✗ External API failed for ${e}, falling back to local data`);try{return await h(e)}catch(t){throw console.error(`✗ Failed to load local data for ${e}:`,t),Error(`Failed to load ${e}: external API and local fallback both failed`)}}}))}async function p(e){try{let t=await u(e);return console.log(`✓ Successfully fetched ${e} from external API`),{type:e,data:t,lastUpdated:new Date().toISOString()}}catch{console.log(`✗ External API failed for ${e}, falling back to local data`);try{return await h(e)}catch(t){throw console.error(`✗ Failed to load local data for ${e}:`,t),Error(`Failed to load ${e}: external API and local fallback both failed`)}}}async function h(e){try{{let t=await Promise.resolve().then(r.t.bind(r,629,23)),a=(await Promise.resolve().then(r.t.bind(r,5315,23))).join(process.cwd(),"public",{"stocked-streams":"/data/stocked-streams.json","stocked-lakes":"/data/stocked-lakes.json","wild-streams":"/data/wild-streams.json"}[e]),s=await t.readFile(a,"utf-8"),o=JSON.parse(s);return{type:e,data:o,lastUpdated:new Date().toISOString()}}}catch(t){throw console.error(`Error loading local ${e} data:`,t),t}}class f{set(e,t,r){let a=Date.now(),s=a+(r||this.defaultTTL);this.cache.set(e,{data:t,timestamp:a,expiresAt:s})}get(e){let t=this.cache.get(e);return t?Date.now()>t.expiresAt?(this.cache.delete(e),null):t.data:null}getStatus(e){let t=this.cache.get(e);if(!t)return{isCached:!1};let r=Date.now();return r>t.expiresAt?(this.cache.delete(e),{isCached:!1}):{isCached:!0,lastUpdated:new Date(t.timestamp).toISOString(),expiresAt:new Date(t.expiresAt).toISOString(),age:r-t.timestamp}}clear(e){this.cache.delete(e)}clearAll(){this.cache.clear()}has(e){return null!==this.get(e)}constructor(){this.cache=new Map,this.defaultTTL=36e5}}let g=new f,m="geojson-";async function w(e){try{let t=e.nextUrl.searchParams,r=t.get("layer"),a="true"===t.get("refresh");if(r){let e=`${m}${r}`,t=null;a||(t=g.get(e)),t||(console.log(`Fetching fresh GeoJSON data for ${r}...`),t=await p(r),g.set(e,t));let s=g.getStatus(e);return c.NextResponse.json({success:!0,data:t,cache:s})}{let e=`${m}all`,t=null;a||(t=g.get(e)),t||(console.log("Fetching fresh GeoJSON data for all layers..."),t=await d(),g.set(e,t));let r=g.getStatus(e);return c.NextResponse.json({success:!0,data:t,cache:r})}}catch(e){return console.error("Error in geojson API:",e),c.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to fetch GeoJSON data"},{status:500})}}async function y(e){try{let t=(await e.json()).layer;if(t){let e=`${m}${t}`;g.clear(e);let r=await p(t);return g.set(e,r),c.NextResponse.json({success:!0,message:`Cache refreshed for ${t}`})}{g.clear(`${m}all`),g.clear(`${m}stocked-streams`),g.clear(`${m}stocked-lakes`),g.clear(`${m}wild-streams`);let e=await d();return g.set(`${m}all`,e),c.NextResponse.json({success:!0,message:"Cache refreshed for all layers"})}}catch(e){return console.error("Error refreshing GeoJSON data:",e),c.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to refresh GeoJSON data"},{status:500})}}let S=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/geojson/route",pathname:"/api/geojson",filename:"route",bundlePath:"app/api/geojson/route"},resolvedPagePath:"/workspace/virginia-trout-map/app/api/geojson/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:$,staticGenerationAsyncStorage:E,serverHooks:x}=S,j="/api/geojson/route";function k(){return(0,n.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:E})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[573,781],()=>r(4082));module.exports=a})();